#
# Partner PowerUp Vegas Casino - Clean ACE-BOX Role
#

---
- set_fact:
    role_path_abs: "{{ role_path }}"
    vegas_repo_url: "https://github.com/lawrobar90/Perform-Vegas-Casino.git"
    vegas_app_dir: "/home/{{ ace_box_user | default('dt_training') }}/vegas-casino"
    vegas_domain: "vegas.{{ ingress_domain }}"

- include_role:
    name: dt-access-token
  vars:
    access_token_var_name: "monaco_cleanup_api_token"
    access_token_scope: ["ReadConfig", "WriteConfig", "events.ingest", "settings.read", "settings.write", "metrics.ingest", "openTelemetryTrace.ingest", "logs.ingest"]

- include_role:
    name: "microk8s"

# Install Node.js via ACE-BOX role for startup script compatibility
- name: Install Node.js via ACE-BOX role
  block:
    - include_role:
        name: "nodejs"
      vars:
        nodejs_node_version: "v18.20.1"
  rescue:
    - name: Verify Node.js is available despite YARN failure
      ansible.builtin.shell: |
        . ~/.nvm/nvm.sh && node --version
      args:
        executable: /bin/bash
      become_user: "{{ ace_box_user | default('dt_training') }}"
      register: node_version_result
      
    - name: Log Node.js status
      ansible.builtin.debug:
        msg: "Node.js available: {{ node_version_result.stdout }} (YARN installation failed but not required for Vegas Casino)"

    - name: Ensure Node.js is in PATH for current session
      ansible.builtin.shell: |
        echo 'export PATH="$HOME/.nvm/versions/node/v18.20.1/bin:$PATH"' >> ~/.bashrc
        . ~/.bashrc
      become_user: "{{ ace_box_user | default('dt_training') }}"
      failed_when: false

# Install OneAgent BEFORE app for proper instrumentation
- include_role:
    name: "dt-oneagent-classic"

# Deploy Monaco configuration
- include_role:
    name: "monaco-v2"
  vars:
    monaco_working_dir: "{{ role_path_abs }}/files/monaco"
    monaco_environment:
      DT_API_TOKEN: "{{ dynatrace_api_token }}"
      DT_PLATFORM_TENANT_URL: "{{ extra_vars.dt_environment_url_gen3.rstrip('/') }}"
      DT_OAUTH_CLIENT_ID: "{{ extra_vars.dt_oauth_client_id }}"
      DT_OAUTH_CLIENT_SECRET: "{{ extra_vars.dt_oauth_client_secret }}"
      DT_OAUTH_SSO_ENDPOINT: "{{ extra_vars.dt_oauth_sso_endpoint }}"
      INGRESS_DOMAIN: "{{ ingress_domain }}"

# Deploy Vegas Casino as Kubernetes application
- name: Apply Vegas Casino Kubernetes manifests
  kubernetes.core.k8s:
    definition: |
      apiVersion: v1
      kind: Namespace
      metadata:
        name: vegas-casino
        labels:
          name: vegas-casino
      ---
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: vegas-casino-config
        namespace: vegas-casino
      data:
        ACE_BOX_ID: "{{ ace_box_id | default('ace-box-demo') }}"
        VEGAS_EXTERNAL_URL: "http://{{ vegas_domain }}"
        NODE_ENV: "production"
        PORT: "8080"
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: vegas-casino-app
        namespace: vegas-casino
        labels:
          app: vegas-casino
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: vegas-casino
        template:
          metadata:
            labels:
              app: vegas-casino
          spec:
            containers:
            - name: vegas-casino
              image: node:18-alpine
              workingDir: /app
              command: ["/bin/sh", "-c"]
              args:
                - |
                  apk add --no-cache git bash curl
                  git clone https://github.com/lawrobar90/Perform-Vegas-Casino.git /app
                  cd /app
                  npm install
                  # Use node server.js directly instead of the complex startup script
                  exec node server.js
              ports:
              - containerPort: 8080
                name: http
              envFrom:
              - configMapRef:
                  name: vegas-casino-config
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "250m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
              livenessProbe:
                httpGet:
                  path: /health
                  port: 8080
                initialDelaySeconds: 60
                periodSeconds: 30
                timeoutSeconds: 10
                failureThreshold: 3
              readinessProbe:
                httpGet:
                  path: /health
                  port: 8080
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: vegas-casino-service
        namespace: vegas-casino
        labels:
          app: vegas-casino
      spec:
        selector:
          app: vegas-casino
        ports:
        - name: http
          port: 80
          targetPort: 8080
          protocol: TCP
        type: ClusterIP
      ---
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: vegas-casino-ingress
        namespace: vegas-casino
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
          nginx.ingress.kubernetes.io/ssl-redirect: "false"
      spec:
        ingressClassName: "public"
        rules:
        - host: vegas.{{ ingress_domain }}
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: vegas-casino-service
                  port:
                    number: 80
    state: present

- name: Wait for Vegas Casino deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: vegas-casino-app
    namespace: vegas-casino
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300

- name: Verify Vegas Casino application health via ingress
  ansible.builtin.uri:
    url: "http://vegas.{{ ingress_domain }}/health"
    method: GET
    status_code: 200
  register: vegas_health_check
  retries: 10
  delay: 15
  until: vegas_health_check is succeeded

# Deploy Vegas Casino Dashboard using template
- name: Apply Vegas Casino Dashboard from template
  kubernetes.core.k8s:
    definition: "{{ lookup('template', 'vegas-dashboard.yml.j2') | from_yaml_all | list }}"
    state: present

# Deploy collaboration tools
- include_role:
    name: "mattermost"

# Fix Mattermost ingress configuration for proper public access
- name: Fix Mattermost ingress service name and configuration
  block:
    - name: Delete any existing incorrect Mattermost ingress
      kubernetes.core.k8s:
        api_version: networking.k8s.io/v1
        kind: Ingress
        name: mattermost-mattermost-team-edition
        namespace: mattermost
        state: absent
      failed_when: false
      
    - name: Create correct Mattermost ingress
      kubernetes.core.k8s:
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: mattermost-mattermost-team-edition
            namespace: mattermost
            annotations:
              kubernetes.io/ingress.class: public
              nginx.ingress.kubernetes.io/proxy-body-size: "0"
              nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
              nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
          spec:
            ingressClassName: "public"
            rules:
            - host: "mattermost.{{ ingress_domain }}"
              http:
                paths:
                - path: /
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: mattermost-team-edition
                      port:
                        number: 8065
        state: present
      register: mattermost_ingress_result
      
    - name: Log Mattermost ingress fix
      ansible.builtin.debug:
        msg: "Mattermost ingress fixed: {{ mattermost_ingress_result is succeeded }}"

# Get Mattermost credentials for dashboard configuration
- name: Get Mattermost admin password for dashboard
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: mattermost-team-edition
    namespace: mattermost
  register: mattermost_secret
  failed_when: false

- name: Set Mattermost credentials for dashboard
  ansible.builtin.set_fact:
    mattermost_password: "{{ mattermost_secret.resources[0].data.password | b64decode | default('admin123') if mattermost_secret.resources else 'admin123' }}"

# Log deployment completion
- name: Display Vegas Casino deployment completion
  ansible.builtin.debug:
    msg: |
      üé∞ Vegas Casino ACE-Box Extension Deployment Complete! üé∞
      
      ‚úÖ Deployment Order Completed:
      1. ‚úÖ Dynatrace OneAgent & Monaco Config
      2. ‚úÖ Vegas Casino Kubernetes App (verified healthy)
      3. ‚úÖ ACE Dashboard (nginx-based, OneAgent compatible)
      4. ‚úÖ Mattermost Collaboration
      5. ‚úÖ Public Access Configuration
      
      üîó Access URLs:
      - üé∞ Vegas Casino: http://vegas.{{ ingress_domain }}/
      - üìä ACE Dashboard: http://dashboard.{{ ingress_domain }}/
      - üí¨ Mattermost: http://mattermost.{{ ingress_domain }}/
      - üîç Dynatrace: {{ extra_vars.dt_environment_url_gen3.rstrip('/') }}
      
      üéØ Vegas Casino Features Ready:
      - Gaming Portfolio: Blackjack, Roulette, Slots
      - Real-time Cheat Detection & Lockout System
      - Admin Lockout API: http://vegas.{{ ingress_domain }}/admin
      - Health Monitoring: http://vegas.{{ ingress_domain }}/health
      - Performance Optimization with Dynatrace OneAgent
      
      üé≠ Demo Scenarios:
      - Gaming Performance: Real-time cheat detection algorithms
      - Lockout System: Instant user management and appeals
      - Matrix Rain UI: Enhanced visual effects and animations
      - Socket.IO Integration: Real-time multiplayer features
      
      üöÄ Ready for Dynatrace Performance demos with Vegas Casino!
      
      ‚úÖ Technical Summary:
      - Vegas Casino: ‚úÖ Kubernetes deployment with ingress
      - ACE Dashboard: ‚úÖ nginx-based, OneAgent compatible  
      - Public Access: ‚úÖ All services accessible via ingress
      - Mattermost Password: {{ mattermost_password }}
      
      üí° All services deployed with ACE-BOX standards and Kubernetes best practices!
